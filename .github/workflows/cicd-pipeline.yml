name: CI/CD Pipeline - GCP Infrastructure

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  PROJECT_ID: praxis-gear-483220-k4
  TF_VERSION: 1.5.0
  TERRAFORM_DIR: .
  # Enterprise WIF configuration (shared infrastructure)
  WIF_PROVIDER: 'projects/251838763754/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions'
  WIF_SERVICE_ACCOUNT: 'github-actions-sa@praxis-gear-483220-k4.iam.gserviceaccount.com'

jobs:
  # Job 1: Validate and Lint
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Format Check
      run: |
        echo "üîç Checking Terraform formatting..."
        terraform fmt -check -recursive
      continue-on-error: true
      
    - name: Terraform Init
      run: |
        echo "üîß Initializing Terraform..."
        terraform init -backend=false
        
    - name: Terraform Validate
      run: |
        echo "‚úÖ Validating Terraform configuration..."
        terraform validate
        
    - name: TFLint Setup
      uses: terraform-linters/setup-tflint@v4
      
    - name: Run TFLint
      run: |
        echo "üîç Running TFLint..."
        tflint --init
        tflint --format compact
      continue-on-error: true

  # Job 2: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Run Checkov Security Scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: terraform
        output_format: cli
        soft_fail: true
        
    - name: Security Scan Summary
      run: |
        echo "üîê Security scan completed"
        echo "Review any findings above"

  # Job 3: Plan (Dev Environment)
  plan-dev:
    name: Plan - Development
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP with WIF
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Init (Development)
      run: |
        cd environments/dev
        terraform init
      
    - name: Terraform Plan (Development)
      id: plan
      run: |
        cd environments/dev
        echo "üìã Running Terraform Plan for Development..."
        terraform plan \
          -var-file="terraform.tfvars" \
          -out=tfplan-dev \
          -no-color | tee plan-output.txt
      continue-on-error: true
      
    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-dev
        path: environments/dev/tfplan-dev
        retention-days: 5
        
    - name: Comment PR with Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('environments/dev/plan-output.txt', 'utf8');
          const output = `#### üèóÔ∏è Terraform Plan - Development Environment
          
          **Status**: ${{ steps.plan.outcome }}
          
          <details><summary>üìã Show Plan Details</summary>
          
          \`\`\`terraform
          ${plan}
          \`\`\`
          
          </details>
          
          **Workflow**: \`${{ github.workflow }}\`
          **Triggered by**: @${{ github.actor }}
          **Commit**: ${{ github.sha }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  # Job 4: Deploy (Dev Environment)
  deploy-dev:
    name: Deploy - Development
    runs-on: ubuntu-latest
    needs: plan-dev
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
      url: https://console.cloud.google.com/compute/instances?project=praxis-gear-483220-k4
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP with WIF
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Init (Development)
      run: |
        cd environments/dev
        terraform init
        
    - name: Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-dev
        path: environments/dev/
        
    - name: Terraform Apply (Development)
      run: |
        cd environments/dev
        echo "üöÄ Deploying to Development Environment..."
        terraform apply -auto-approve tfplan-dev
        
    - name: Get Terraform Outputs
      id: outputs
      run: |
        cd environments/dev
        echo "üìä Infrastructure Outputs:"
        terraform output -json > outputs.json
        cat outputs.json
        
    - name: Upload Outputs
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs-dev
        path: environments/dev/outputs.json
        retention-days: 30

  # Job 5: Plan (Staging Environment)
  plan-staging:
    name: Plan - Staging
    runs-on: ubuntu-latest
    needs: [validate, security-scan, deploy-dev]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP with WIF
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Init (Staging)
      run: |
        cd environments/staging
        terraform init
      
    - name: Terraform Plan (Staging)
      run: |
        cd environments/staging
        echo "üìã Running Terraform Plan for Staging..."
        terraform plan \
          -var-file="terraform.tfvars" \
          -out=tfplan-staging \
          -no-color
          
    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-staging
        path: environments/staging/tfplan-staging
        retention-days: 5

  # Job 6: Deploy (Staging Environment)
  deploy-staging:
    name: Deploy - Staging
    runs-on: ubuntu-latest
    needs: plan-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: https://console.cloud.google.com/compute/instances?project=praxis-gear-483220-k4
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP with WIF
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Init (Staging)
      run: |
        cd environments/staging
        terraform init
        
    - name: Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-staging
        path: environments/staging/
        
    - name: Terraform Apply (Staging)
      run: |
        cd environments/staging
        echo "üöÄ Deploying to Staging Environment..."
        terraform apply -auto-approve tfplan-staging

  # Job 7: Plan (Production Environment)
  plan-prod:
    name: Plan - Production
    runs-on: ubuntu-latest
    needs: [validate, security-scan, deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP with WIF
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Init (Production)
      run: |
        cd environments/prod
        terraform init
      
    - name: Terraform Plan (Production)
      run: |
        cd environments/prod
        echo "üìã Running Terraform Plan for Production..."
        terraform plan \
          -var-file="terraform.tfvars" \
          -out=tfplan-prod \
          -no-color
          
    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-prod
        path: environments/prod/tfplan-prod
        retention-days: 5

  # Job 8: Deploy (Production Environment) - WITH APPROVAL GATE
  deploy-prod:
    name: Deploy - Production
    runs-on: ubuntu-latest
    needs: plan-prod
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://console.cloud.google.com/compute/instances?project=praxis-gear-483220-k4
    
    permissions:
      contents: read
      id-token: write
      
    steps:
    - name: Production Deployment Notice
      run: |
        echo "üö® PRODUCTION DEPLOYMENT STARTING"
        echo "=================================="
        echo "Environment: Production"
        echo "Triggered by: @${{ github.actor }}"
        echo "Commit: ${{ github.sha }}"
        echo "Time: $(date)"
        echo ""
        echo "‚ö†Ô∏è  This deployment will affect production systems!"
        echo "üîç Ensure all tests have passed and staging is validated"
        
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Authenticate to GCP with WIF
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WIF_PROVIDER }}
        service_account: ${{ env.WIF_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Terraform Init (Production)
      run: |
        cd environments/prod
        terraform init
        
    - name: Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-prod
        path: environments/prod/
        
    - name: Terraform Apply (Production)
      run: |
        cd environments/prod
        echo "üè≠ Deploying to Production Environment..."
        terraform apply -auto-approve tfplan-prod
        
    - name: Get Terraform Outputs
      run: |
        cd environments/prod
        echo "üìä Production Infrastructure Outputs:"
        terraform output
        
    - name: Production Deployment Success
      run: |
        echo "## üéâ Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚ö†Ô∏è Post-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Verify application health endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Check monitoring dashboards" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Review error logs" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Validate performance metrics" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Update runbook documentation" >> $GITHUB_STEP_SUMMARY

  # Job 9: Notify on Failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate, security-scan, plan-dev, deploy-dev, plan-staging, deploy-staging, plan-prod, deploy-prod]
    if: failure()
    
    steps:
    - name: Failure Notification
      run: |
        echo "## ‚ùå Pipeline Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "One or more jobs in the CI/CD pipeline failed." >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY