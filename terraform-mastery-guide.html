<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Terraform Mastery Guide - Complete Learning Platform</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #623CE4;
            --secondary: #4285F4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gradient-1);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .hero-section {
            background: var(--gradient-1);
            color: white;
            padding: 100px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .hero-title {
            font-size: 4rem;
            margin-bottom: 20px;
            font-weight: 800;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: fadeInUp 1s ease-out;
        }
        
        .hero-subtitle {
            font-size: 1.8rem;
            margin-bottom: 30px;
            opacity: 0.9;
            animation: fadeInUp 1s ease-out 0.2s both;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .main-content {
            background: white;
            border-radius: 30px;
            margin: -80px auto 50px;
            padding: 60px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.1);
            position: relative;
            z-index: 2;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 50px;
            gap: 5px;
            background: var(--light);
            padding: 10px;
            border-radius: 50px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(98, 60, 228, 0.3);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(98, 60, 228, 0.1);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: var(--dark);
            text-align: center;
            font-weight: 700;
        }
        
        .section-subtitle {
            font-size: 1.2rem;
            color: #64748b;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .concept-card {
            background: linear-gradient(135deg, white 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(98, 60, 228, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .concept-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-3);
        }
        
        .concept-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .concept-icon {
            font-size: 2.5rem;
            margin-bottom: 20px;
            display: block;
        }
        
        .concept-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .concept-description {
            color: #64748b;
            line-height: 1.7;
            margin-bottom: 20px;
        }
        
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .flow-diagram {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            border: 2px solid rgba(98, 60, 228, 0.1);
        }
        
        .flow-step {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            margin: 10px;
            font-weight: 600;
            position: relative;
        }
        
        .flow-step::after {
            content: 'â†’';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .flow-step:last-child::after {
            display: none;
        }
        
        .interactive-demo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .demo-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .demo-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .architecture-flow {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            position: relative;
            overflow: hidden;
            margin: 30px 0;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .main-content {
                margin: -50px 10px 30px;
                padding: 30px 20px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .concept-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <h1 class="hero-title">ğŸ“ Terraform Mastery Guide</h1>
            <p class="hero-subtitle">Complete Learning Platform - From Basics to Advanced Architecture</p>
            <p style="font-size: 1.2rem; opacity: 0.8; margin-top: 20px;">
                Master every aspect of Terraform with interactive examples from our real GCP project
            </p>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('basics')">ğŸ”° Basics</button>
                <button class="nav-tab" onclick="showTab('structure')">ğŸ“ Structure</button>
                <button class="nav-tab" onclick="showTab('variables')">ğŸ”§ Variables</button>
                <button class="nav-tab" onclick="showTab('modules')">ğŸ“¦ Modules</button>
                <button class="nav-tab" onclick="showTab('backend')">ğŸ—„ï¸ Backend</button>
                <button class="nav-tab" onclick="showTab('workflow')">ğŸ”„ Workflow</button>
                <button class="nav-tab" onclick="showTab('functions')">âš¡ Functions</button>
                <button class="nav-tab" onclick="showTab('meta')">ğŸ¯ Meta Args</button>
                <button class="nav-tab" onclick="showTab('wif')">ğŸ” WIF Deep Dive</button>
                <button class="nav-tab" onclick="showTab('advanced')">ğŸš€ Advanced</button>
            </div>
            
            <!-- Basics Tab -->
            <div id="basics-tab" class="tab-content active">
                <h2 class="section-title">ğŸ”° Terraform Fundamentals</h2>
                <p class="section-subtitle">Understanding the core concepts and how Terraform works</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ—ï¸</span>
                        <h3 class="concept-title">What is Terraform?</h3>
                        <div class="concept-description">
                            Terraform is an Infrastructure as Code (IaC) tool that allows you to define and provision infrastructure using declarative configuration files.
                        </div>
                        <div class="code-block">
# Simple example - Creating a GCP VM
resource "google_compute_instance" "vm" {
  name         = "my-vm"
  machine_type = "e2-medium"
  zone         = "us-central1-a"
  
  boot_disk {
    initialize_params {
      image = "ubuntu-os-cloud/ubuntu-2204-lts"
    }
  }
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“‹</span>
                        <h3 class="concept-title">Declarative vs Imperative</h3>
                        <div class="concept-description">
                            <strong>Declarative:</strong> You describe WHAT you want<br>
                            <strong>Imperative:</strong> You describe HOW to do it
                        </div>
                        <div class="code-block">
# Declarative (Terraform)
resource "google_compute_instance" "vm" {
  name = "web-server"
  # Terraform figures out HOW to create it
}

# vs Imperative (Script)
# 1. Check if VM exists
# 2. If not, create VM
# 3. Configure VM
# 4. Start VM
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”„</span>
                        <h3 class="concept-title">Terraform Lifecycle</h3>
                        <div class="concept-description">
                            Understanding the core Terraform commands and what happens behind the scenes.
                        </div>
                        <div class="flow-diagram">
                            <div class="flow-step">terraform init</div>
                            <div class="flow-step">terraform plan</div>
                            <div class="flow-step">terraform apply</div>
                            <div class="flow-step">terraform destroy</div>
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“Š</span>
                        <h3 class="concept-title">State Management</h3>
                        <div class="concept-description">
                            Terraform keeps track of your infrastructure in a state file. This is crucial for understanding what exists and what needs to change.
                        </div>
                        <div class="code-block">
# State file tracks:
# - What resources exist
# - Their current configuration
# - Dependencies between resources
# - Metadata about resources

# Example state entry
{
  "mode": "managed",
  "type": "google_compute_instance",
  "name": "vm",
  "instances": [...]
}
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: What happens when you run terraform apply?</h3>
                    <p>Click to see the step-by-step process:</p>
                    <button class="demo-button" onclick="showTerraformProcess()">Run terraform apply</button>
                    <div id="terraform-process" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Behind the Scenes Process:</h4>
                            <ol style="text-align: left; margin-top: 15px;">
                                <li><strong>Read Configuration:</strong> Parse .tf files</li>
                                <li><strong>Load State:</strong> Read current state file</li>
                                <li><strong>Refresh State:</strong> Check actual infrastructure</li>
                                <li><strong>Create Plan:</strong> Compare desired vs actual</li>
                                <li><strong>Execute Plan:</strong> Make API calls to create/modify/delete</li>
                                <li><strong>Update State:</strong> Record changes in state file</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Structure Tab -->
            <div id="structure-tab" class="tab-content">
                <h2 class="section-title">ğŸ“ Project Structure Deep Dive</h2>
                <p class="section-subtitle">Understanding how our GCP project is organized and why</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ—ï¸</span>
                        <h3 class="concept-title">Root vs Environment vs Modules</h3>
                        <div class="concept-description">
                            Understanding the hierarchy and relationships in our project structure.
                        </div>
                        <div class="code-block">
ğŸ“¦ Our Project Structure:
â”œâ”€â”€ ğŸ“‚ environments/          # Environment-specific configs
â”‚   â”œâ”€â”€ dev/                 # Development environment
â”‚   â”‚   â”œâ”€â”€ main.tf          # Root module for dev
â”‚   â”‚   â”œâ”€â”€ variables.tf     # Dev-specific variables
â”‚   â”‚   â”œâ”€â”€ outputs.tf       # Dev outputs
â”‚   â”‚   â””â”€â”€ terraform.tfvars # Dev values
â”‚   â”œâ”€â”€ staging/             # Staging environment
â”‚   â””â”€â”€ prod/                # Production environment
â”œâ”€â”€ ğŸ“‚ modules/              # Reusable modules
â”‚   â”œâ”€â”€ network/             # Network module
â”‚   â”œâ”€â”€ compute/             # Compute module
â”‚   â”œâ”€â”€ iam/                 # IAM module
â”‚   â””â”€â”€ security/            # Security module
â””â”€â”€ ğŸ“‚ shared/               # Shared infrastructure
    â””â”€â”€ wif/                 # Workload Identity Federation
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ¯</span>
                        <h3 class="concept-title">Root Module (environments/dev/)</h3>
                        <div class="concept-description">
                            The root module is where you run terraform commands. It orchestrates other modules.
                        </div>
                        <div class="code-block">
# environments/dev/main.tf (ROOT MODULE)
terraform {
  # Backend configuration
  backend "gcs" {
    bucket = "my-terraform-state"
    prefix = "environments/development"
  }
}

# Call child modules
module "network" {
  source = "../../modules/network"
  # Pass variables to module
  project_id = var.project_id
  environment = var.environment
}

module "compute" {
  source = "../../modules/compute"
  # Use outputs from network module
  network_name = module.network.vpc_name
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“¦</span>
                        <h3 class="concept-title">Child Modules (modules/network/)</h3>
                        <div class="concept-description">
                            Child modules are reusable components that create specific resources.
                        </div>
                        <div class="code-block">
# modules/network/main.tf (CHILD MODULE)
resource "google_compute_network" "vpc" {
  name = "${var.environment}-vpc"
  # Creates actual GCP VPC
}

resource "google_compute_subnetwork" "subnet" {
  name    = "${var.environment}-subnet"
  network = google_compute_network.vpc.id
  # Creates subnet in the VPC
}

# modules/network/variables.tf
variable "environment" {
  description = "Environment name"
  type        = string
}

# modules/network/outputs.tf
output "vpc_name" {
  value = google_compute_network.vpc.name
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”—</span>
                        <h3 class="concept-title">How They Connect</h3>
                        <div class="concept-description">
                            Understanding the data flow between root modules and child modules.
                        </div>
                        <div class="architecture-flow" id="module-flow">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Module Communication</h3>
                    <p>See how data flows between modules in our project:</p>
                    <button class="demo-button" onclick="showModuleFlow()">Show Module Flow</button>
                    <div id="module-communication" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Data Flow Example:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <p><strong>1. Root Module (dev/main.tf):</strong></p>
                                <code>module "network" { environment = "dev" }</code>
                                
                                <p style="margin-top: 15px;"><strong>2. Network Module creates:</strong></p>
                                <code>resource "google_compute_network" "vpc" { name = "dev-vpc" }</code>
                                
                                <p style="margin-top: 15px;"><strong>3. Network Module outputs:</strong></p>
                                <code>output "vpc_name" { value = "dev-vpc" }</code>
                                
                                <p style="margin-top: 15px;"><strong>4. Root Module uses output:</strong></p>
                                <code>module "compute" { network_name = module.network.vpc_name }</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Variables Tab -->
            <div id="variables-tab" class="tab-content">
                <h2 class="section-title">ğŸ”§ Variables, Locals & Data Sources</h2>
                <p class="section-subtitle">Master input variables, local values, and data sources</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“¥</span>
                        <h3 class="concept-title">Input Variables</h3>
                        <div class="concept-description">
                            Input variables are like function parameters - they allow you to customize module behavior.
                        </div>
                        <div class="code-block">
# variables.tf - Define the variable
variable "environment" {
  description = "Environment name (dev, staging, prod)"
  type        = string
  default     = "dev"
  
  validation {
    condition = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be dev, staging, or prod."
  }
}

# main.tf - Use the variable
resource "google_compute_instance" "vm" {
  name = "${var.environment}-vm"  # Results in "dev-vm"
}

# terraform.tfvars - Set the value
environment = "dev"
project_id  = "my-gcp-project"
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ </span>
                        <h3 class="concept-title">Local Values</h3>
                        <div class="concept-description">
                            Locals are like local variables in programming - computed values used within a module.
                        </div>
                        <div class="code-block">
# locals.tf or in main.tf
locals {
  # Computed values
  common_tags = {
    environment = var.environment
    managed_by  = "terraform"
    project     = var.project_id
    team        = var.team
  }
  
  # String manipulation
  vm_name = "${var.environment}-${var.application}-vm"
  
  # Conditional logic
  machine_type = var.environment == "prod" ? "e2-standard-4" : "e2-medium"
}

# Use locals in resources
resource "google_compute_instance" "vm" {
  name         = local.vm_name
  machine_type = local.machine_type
  labels       = local.common_tags
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“Š</span>
                        <h3 class="concept-title">Data Sources</h3>
                        <div class="concept-description">
                            Data sources fetch information about existing infrastructure or external data.
                        </div>
                        <div class="code-block">
# Fetch existing VPC information
data "google_compute_network" "existing_vpc" {
  name = "default"
}

# Fetch remote state from another Terraform configuration
data "terraform_remote_state" "shared_wif" {
  backend = "gcs"
  config = {
    bucket = "my-terraform-state"
    prefix = "shared/wif"
  }
}

# Use data source outputs
resource "google_compute_instance" "vm" {
  network_interface {
    network = data.google_compute_network.existing_vpc.id
  }
}

# Use remote state data
locals {
  wif_pool = data.terraform_remote_state.shared_wif.outputs.pool_name
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“‹</span>
                        <h3 class="concept-title">Variable Types & Validation</h3>
                        <div class="concept-description">
                            Terraform supports various data types and validation rules for robust configurations.
                        </div>
                        <div class="code-block">
# String variable
variable "project_id" {
  type        = string
  description = "GCP Project ID"
}

# Number variable
variable "disk_size" {
  type        = number
  default     = 20
  description = "Disk size in GB"
}

# Boolean variable
variable "enable_monitoring" {
  type        = bool
  default     = true
  description = "Enable monitoring"
}

# List variable
variable "ssh_source_ranges" {
  type        = list(string)
  default     = ["10.0.0.0/8"]
  description = "Allowed SSH source ranges"
}

# Object variable
variable "vm_config" {
  type = object({
    machine_type = string
    disk_size    = number
    zone         = string
  })
  default = {
    machine_type = "e2-medium"
    disk_size    = 20
    zone         = "us-central1-a"
  }
}

# Map variable
variable "labels" {
  type        = map(string)
  default     = {}
  description = "Resource labels"
}
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Variable Flow in Our Project</h3>
                    <p>See how variables flow through our multi-environment setup:</p>
                    <button class="demo-button" onclick="showVariableFlow()">Show Variable Flow</button>
                    <div id="variable-flow-demo" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Variable Flow Example:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <p><strong>1. terraform.tfvars (Environment-specific values):</strong></p>
                                <code>environment = "dev"<br>machine_type = "e2-medium"</code>
                                
                                <p style="margin-top: 15px;"><strong>2. variables.tf (Variable definitions):</strong></p>
                                <code>variable "environment" { type = string }</code>
                                
                                <p style="margin-top: 15px;"><strong>3. main.tf (Pass to modules):</strong></p>
                                <code>module "compute" { environment = var.environment }</code>
                                
                                <p style="margin-top: 15px;"><strong>4. Module uses variable:</strong></p>
                                <code>name = "${var.environment}-vm" # Results in "dev-vm"</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modules Tab -->
            <div id="modules-tab" class="tab-content">
                <h2 class="section-title">ğŸ“¦ Modules Deep Dive</h2>
                <p class="section-subtitle">Understanding module creation, composition, and best practices</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ—ï¸</span>
                        <h3 class="concept-title">Module Anatomy</h3>
                        <div class="concept-description">
                            Every module has the same basic structure with specific files for different purposes.
                        </div>
                        <div class="code-block">
ğŸ“¦ modules/network/
â”œâ”€â”€ main.tf          # Primary resource definitions
â”œâ”€â”€ variables.tf     # Input variables
â”œâ”€â”€ outputs.tf       # Output values
â”œâ”€â”€ versions.tf      # Provider requirements (optional)
â””â”€â”€ README.md        # Documentation (optional)

# main.tf - What the module creates
resource "google_compute_network" "vpc" {
  name = "${var.environment}-vpc"
}

# variables.tf - What the module needs
variable "environment" {
  type = string
}

# outputs.tf - What the module provides
output "vpc_name" {
  value = google_compute_network.vpc.name
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”—</span>
                        <h3 class="concept-title">Module Dependencies</h3>
                        <div class="concept-description">
                            How modules depend on each other and pass data between them.
                        </div>
                        <div class="code-block">
# Root module (environments/dev/main.tf)
module "network" {
  source = "../../modules/network"
  
  project_id  = var.project_id
  environment = var.environment
  subnet_cidr = var.subnet_cidr
}

module "security" {
  source = "../../modules/security"
  
  # Depends on network module output
  network_name = module.network.vpc_name
  subnet_cidr  = var.subnet_cidr
}

module "compute" {
  source = "../../modules/compute"
  
  # Depends on both network and IAM modules
  network_name          = module.network.vpc_name
  subnet_name           = module.network.subnet_name
  service_account_email = module.iam.vm_service_account_email
}

# Terraform automatically handles dependency order:
# 1. Network module runs first
# 2. Security and IAM modules run next (parallel)
# 3. Compute module runs last
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ¯</span>
                        <h3 class="concept-title">Module Composition Patterns</h3>
                        <div class="concept-description">
                            Different ways to structure and compose modules for maximum reusability.
                        </div>
                        <div class="code-block">
# Pattern 1: Granular Modules (Our Approach)
module "network" { ... }    # Just networking
module "compute" { ... }    # Just VMs
module "iam" { ... }        # Just IAM

# Pattern 2: Composite Modules
module "web_tier" {
  # Includes network + compute + security
}

# Pattern 3: Environment Modules
module "complete_environment" {
  # Includes everything for one environment
}

# Our project uses Pattern 1 because:
# âœ… Maximum flexibility
# âœ… Easy to test individual components
# âœ… Clear separation of concerns
# âœ… Reusable across different scenarios
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”„</span>
                        <h3 class="concept-title">Module Versioning & Sources</h3>
                        <div class="concept-description">
                            Different ways to source modules and manage versions.
                        </div>
                        <div class="code-block">
# Local modules (our approach)
module "network" {
  source = "../../modules/network"
}

# Git repository modules
module "vpc" {
  source = "git::https://github.com/company/terraform-modules.git//vpc?ref=v1.0.0"
}

# Terraform Registry modules
module "vpc" {
  source  = "terraform-google-modules/network/google"
  version = "~> 5.0"
}

# Local file system
module "network" {
  source = "../shared-modules/network"
}

# Why we use local modules:
# âœ… Full control over code
# âœ… Easy to modify and test
# âœ… No external dependencies
# âœ… Perfect for learning
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Module Execution Order</h3>
                    <p>See how Terraform determines the order to create resources across modules:</p>
                    <button class="demo-button" onclick="showModuleExecution()">Show Execution Order</button>
                    <div id="module-execution-demo" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Execution Order in Our Project:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <p><strong>Phase 1 (Parallel):</strong></p>
                                <ul>
                                    <li>ğŸŒ Network Module: Creates VPC and subnets</li>
                                    <li>ğŸ” IAM Module: Creates service accounts</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Phase 2:</strong></p>
                                <ul>
                                    <li>ğŸ›¡ï¸ Security Module: Creates firewall rules (needs VPC from Phase 1)</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Phase 3:</strong></p>
                                <ul>
                                    <li>ğŸ’» Compute Module: Creates VMs (needs VPC, subnet, and service account)</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Why this order?</strong></p>
                                <code>
module.compute depends on:<br>
- module.network.vpc_name<br>
- module.network.subnet_name<br>
- module.iam.service_account_email
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Backend Tab -->
            <div id="backend-tab" class="tab-content">
                <h2 class="section-title">ğŸ—„ï¸ Backend & State Management</h2>
                <p class="section-subtitle">Understanding how Terraform tracks and manages infrastructure state</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“Š</span>
                        <h3 class="concept-title">What is State?</h3>
                        <div class="concept-description">
                            Terraform state is a JSON file that maps your configuration to real-world resources.
                        </div>
                        <div class="code-block">
# terraform.tfstate (simplified)
{
  "version": 4,
  "terraform_version": "1.5.0",
  "resources": [
    {
      "mode": "managed",
      "type": "google_compute_instance",
      "name": "vm",
      "instances": [
        {
          "attributes": {
            "name": "dev-vm",
            "machine_type": "e2-medium",
            "zone": "us-central1-a",
            "self_link": "projects/my-project/zones/us-central1-a/instances/dev-vm"
          }
        }
      ]
    }
  ]
}

# State tracks:
# âœ… What resources exist
# âœ… Their current configuration  
# âœ… Resource dependencies
# âœ… Metadata and attributes
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ </span>
                        <h3 class="concept-title">Local vs Remote Backend</h3>
                        <div class="concept-description">
                            Understanding the difference between local and remote state storage.
                        </div>
                        <div class="code-block">
# LOCAL BACKEND (default)
# State stored in local terraform.tfstate file
# âŒ Not suitable for teams
# âŒ No locking mechanism
# âŒ Risk of state corruption

# REMOTE BACKEND (our approach)
terraform {
  backend "gcs" {
    bucket = "praxis-gear-483220-k4-terraform-state"
    prefix = "environments/development/terraform-state"
  }
}

# Benefits of Remote Backend:
# âœ… Team collaboration
# âœ… State locking prevents conflicts
# âœ… Backup and versioning
# âœ… Encryption at rest
# âœ… Access control

# Our backend structure:
# gs://bucket/shared/wif/terraform-state
# gs://bucket/environments/development/terraform-state
# gs://bucket/environments/staging/terraform-state
# gs://bucket/environments/production/terraform-state
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”’</span>
                        <h3 class="concept-title">State Locking</h3>
                        <div class="concept-description">
                            How Terraform prevents multiple people from modifying infrastructure simultaneously.
                        </div>
                        <div class="code-block">
# When you run 'terraform apply':

1. Terraform acquires a lock
   "Acquiring state lock. This may take a few moments..."

2. If someone else is running Terraform:
   "Error: Error locking state: Error acquiring the state lock"

3. Lock information stored in state backend
   {
     "ID": "abc123-def456-ghi789",
     "Operation": "OperationTypeApply", 
     "Info": "user@company.com",
     "Who": "user@hostname",
     "Version": "1.5.0",
     "Created": "2024-01-19T10:30:00Z"
   }

4. Lock released after operation completes

# Force unlock (use carefully!)
terraform force-unlock abc123-def456-ghi789
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”„</span>
                        <h3 class="concept-title">State Operations</h3>
                        <div class="concept-description">
                            Common operations for managing and troubleshooting state.
                        </div>
                        <div class="code-block">
# View current state
terraform show

# List all resources in state
terraform state list

# Show specific resource
terraform state show google_compute_instance.vm

# Remove resource from state (doesn't delete actual resource)
terraform state rm google_compute_instance.vm

# Import existing resource into state
terraform import google_compute_instance.vm projects/my-project/zones/us-central1-a/instances/existing-vm

# Move resource in state (rename)
terraform state mv google_compute_instance.old google_compute_instance.new

# Refresh state (sync with actual infrastructure)
terraform refresh

# Replace resource (force recreation)
terraform apply -replace=google_compute_instance.vm
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: State File Analysis</h3>
                    <p>Explore what's inside our project's state file:</p>
                    <button class="demo-button" onclick="showStateAnalysis()">Analyze State File</button>
                    <div id="state-analysis-demo" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Our Development Environment State Contains:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <p><strong>Network Resources:</strong></p>
                                <ul>
                                    <li>google_compute_network.vpc (development-vpc)</li>
                                    <li>google_compute_subnetwork.subnet (development-subnet)</li>
                                    <li>google_compute_router.router (development-router)</li>
                                    <li>google_compute_router_nat.nat (development-nat)</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Compute Resources:</strong></p>
                                <ul>
                                    <li>google_compute_instance.vm (development-vm)</li>
                                    <li>External IP: 34.59.39.203</li>
                                    <li>Internal IP: 10.10.0.2</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>IAM Resources:</strong></p>
                                <ul>
                                    <li>google_service_account.vm_service_account</li>
                                    <li>google_project_iam_member.* (4 bindings)</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Security Resources:</strong></p>
                                <ul>
                                    <li>google_compute_firewall.* (4 firewall rules)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Workflow Tab -->
            <div id="workflow-tab" class="tab-content">
                <h2 class="section-title">ğŸ”„ Terraform Workflow Deep Dive</h2>
                <p class="section-subtitle">Understanding what happens behind the scenes with each command</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸš€</span>
                        <h3 class="concept-title">terraform init</h3>
                        <div class="concept-description">
                            Initializes a Terraform working directory and downloads required providers.
                        </div>
                        <div class="code-block">
# What 'terraform init' does:

1. ğŸ“ Creates .terraform/ directory
2. ğŸ“¦ Downloads provider plugins
   - hashicorp/google v5.45.0
   - Stores in .terraform/providers/
3. ğŸ”§ Initializes backend
   - Connects to GCS bucket
   - Verifies access permissions
4. ğŸ“‹ Creates .terraform.lock.hcl
   - Locks provider versions
   - Ensures consistent deployments

# Output you see:
Initializing the backend...
Initializing provider plugins...
- Finding hashicorp/google versions matching "~> 5.45.0"...
- Installing hashicorp/google v5.45.0...
Terraform has been successfully initialized!

# Files created:
.terraform/
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ registry.terraform.io/hashicorp/google/5.45.0/
â””â”€â”€ terraform.tfstate (backend config)
.terraform.lock.hcl
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“‹</span>
                        <h3 class="concept-title">terraform plan</h3>
                        <div class="concept-description">
                            Creates an execution plan showing what Terraform will do.
                        </div>
                        <div class="code-block">
# What 'terraform plan' does:

1. ğŸ“– Read configuration files (.tf)
2. ğŸ—„ï¸ Load current state file
3. ğŸ”„ Refresh state (check actual infrastructure)
4. ğŸ“Š Compare desired vs actual state
5. ğŸ“‹ Create execution plan
6. ğŸ¯ Show planned changes

# Plan output symbols:
+ create       # New resource
~ update       # Modify existing resource  
- destroy      # Delete resource
-/+ replace    # Delete then create (recreate)

# Example plan output:
Terraform will perform the following actions:

  # google_compute_instance.vm will be created
  + resource "google_compute_instance" "vm" {
      + name         = "dev-vm"
      + machine_type = "e2-medium"
      + zone         = "us-central1-a"
    }

Plan: 1 to add, 0 to change, 0 to destroy.
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">âš¡</span>
                        <h3 class="concept-title">terraform apply</h3>
                        <div class="concept-description">
                            Executes the planned changes to reach the desired state.
                        </div>
                        <div class="code-block">
# What 'terraform apply' does:

1. ğŸ”’ Acquire state lock
2. ğŸ“‹ Generate plan (if not provided)
3. ğŸ¯ Show plan and ask for confirmation
4. ğŸš€ Execute planned changes:
   - Make API calls to GCP
   - Create/modify/delete resources
   - Handle dependencies and ordering
5. ğŸ“Š Update state file with results
6. ğŸ”“ Release state lock

# Behind the scenes API calls:
Creating google_compute_network.vpc...
â†’ POST https://compute.googleapis.com/compute/v1/projects/my-project/global/networks
â†’ Response: Operation ID abc123

Creating google_compute_instance.vm...  
â†’ POST https://compute.googleapis.com/compute/v1/projects/my-project/zones/us-central1-a/instances
â†’ Response: Operation ID def456

# State file updated with:
- Resource IDs and self-links
- Current configuration
- Metadata and attributes
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ’¥</span>
                        <h3 class="concept-title">terraform destroy</h3>
                        <div class="concept-description">
                            Destroys all resources managed by Terraform configuration.
                        </div>
                        <div class="code-block">
# What 'terraform destroy' does:

1. ğŸ“– Read current state
2. ğŸ“‹ Create destruction plan
3. ğŸ¯ Show what will be destroyed
4. âš ï¸  Ask for confirmation
5. ğŸ—‘ï¸ Delete resources in reverse dependency order:
   - Compute instances first
   - Then subnets
   - Then VPC networks last
6. ğŸ“Š Update state file (remove destroyed resources)

# Destruction order (reverse of creation):
Destroying google_compute_instance.vm...
Destroying google_compute_subnetwork.subnet...
Destroying google_compute_network.vpc...

# Why reverse order?
- VM depends on subnet
- Subnet depends on VPC
- Must delete VM before subnet
- Must delete subnet before VPC

# Our project's destroy order:
1. Compute resources (VMs)
2. Security resources (firewall rules)  
3. Network resources (subnets, NAT, router)
4. VPC network
5. IAM bindings
6. Service accounts
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Complete Workflow Simulation</h3>
                    <p>See the complete workflow from init to destroy:</p>
                    <button class="demo-button" onclick="showWorkflowSimulation()">Simulate Full Workflow</button>
                    <div id="workflow-simulation" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Complete Workflow Simulation:</h4>
                            <div style="text-align: left; margin-top: 15px; font-family: monospace;">
                                <div id="workflow-steps"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Functions Tab -->
            <div id="functions-tab" class="tab-content">
                <h2 class="section-title">âš¡ Terraform Functions</h2>
                <p class="section-subtitle">Master built-in functions for data manipulation and logic</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”¤</span>
                        <h3 class="concept-title">String Functions</h3>
                        <div class="concept-description">
                            Functions for manipulating and formatting strings.
                        </div>
                        <div class="code-block">
# String interpolation and formatting
locals {
  # Basic interpolation
  vm_name = "${var.environment}-vm"  # "dev-vm"
  
  # String functions
  upper_env = upper(var.environment)  # "DEV"
  lower_env = lower(var.environment)  # "dev"
  
  # String manipulation
  project_short = substr(var.project_id, 0, 10)  # First 10 chars
  
  # Replace characters
  safe_name = replace(var.project_id, "-", "_")  # Replace hyphens
  
  # Format strings
  vm_fqdn = format("%s.%s.internal", local.vm_name, var.region)
  
  # Join and split
  tags_string = join(",", var.tags)  # ["a","b"] â†’ "a,b"
  name_parts = split("-", var.vm_name)  # "dev-vm" â†’ ["dev","vm"]
}

# Real examples from our project:
resource "google_compute_instance" "vm" {
  name = "${var.environment}-vm"  # String interpolation
  
  labels = {
    environment = lower(var.environment)  # Ensure lowercase
    name        = replace(var.vm_name, "_", "-")  # GCP label format
  }
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ“‹</span>
                        <h3 class="concept-title">Collection Functions</h3>
                        <div class="concept-description">
                            Functions for working with lists, maps, and sets.
                        </div>
                        <div class="code-block">
# List functions
variable "zones" {
  default = ["us-central1-a", "us-central1-b", "us-central1-c"]
}

locals {
  # List operations
  zone_count = length(var.zones)  # 3
  first_zone = var.zones[0]       # "us-central1-a"
  
  # Filter and transform
  central_zones = [for zone in var.zones : zone if contains(zone, "central")]
  
  # Combine lists
  all_zones = concat(var.zones, ["us-west1-a"])
  
  # Unique values
  unique_zones = distinct(var.all_zones)
}

# Map functions
variable "vm_configs" {
  default = {
    dev  = { machine_type = "e2-medium", disk_size = 20 }
    prod = { machine_type = "e2-standard-4", disk_size = 100 }
  }
}

locals {
  # Map operations
  config_keys = keys(var.vm_configs)      # ["dev", "prod"]
  config_values = values(var.vm_configs)  # [object, object]
  
  # Lookup with default
  machine_type = lookup(var.vm_configs[var.environment], "machine_type", "e2-micro")
  
  # Merge maps
  default_config = { disk_type = "pd-standard" }
  final_config = merge(local.default_config, var.vm_configs[var.environment])
}

# Real example from our project:
resource "google_compute_firewall" "rules" {
  for_each = {
    ssh   = { port = "22", source = var.ssh_source_ranges }
    http  = { port = "80", source = ["0.0.0.0/0"] }
    https = { port = "443", source = ["0.0.0.0/0"] }
  }
  
  name    = "${var.environment}-allow-${each.key}"
  network = var.network_name
  
  allow {
    protocol = "tcp"
    ports    = [each.value.port]
  }
  
  source_ranges = each.value.source
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”€</span>
                        <h3 class="concept-title">Conditional Functions</h3>
                        <div class="concept-description">
                            Functions for conditional logic and decision making.
                        </div>
                        <div class="code-block">
# Conditional expressions
locals {
  # Ternary operator (condition ? true_value : false_value)
  machine_type = var.environment == "prod" ? "e2-standard-4" : "e2-medium"
  
  # Multiple conditions
  disk_size = (
    var.environment == "prod" ? 100 :
    var.environment == "staging" ? 50 : 20
  )
  
  # Null coalescing
  vm_name = coalesce(var.custom_vm_name, "${var.environment}-vm")
  
  # Can function (check if value can be converted)
  valid_number = can(tonumber(var.disk_size_string))
  
  # Try function (attempt operation, return default on error)
  parsed_number = try(tonumber(var.disk_size_string), 20)
}

# Real examples from our project:
resource "google_compute_instance" "vm" {
  machine_type = var.environment == "prod" ? "e2-standard-4" : "e2-medium"
  
  boot_disk {
    initialize_params {
      size = var.environment == "prod" ? 100 : 20
      type = var.environment == "prod" ? "pd-ssd" : "pd-standard"
    }
  }
  
  # Conditional resource creation
  count = var.create_vm ? 1 : 0
}

# Conditional blocks
dynamic "network_interface" {
  for_each = var.enable_external_ip ? [1] : []
  
  content {
    network = var.network_name
    access_config {
      # Ephemeral external IP
    }
  }
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ•’</span>
                        <h3 class="concept-title">Date & Utility Functions</h3>
                        <div class="concept-description">
                            Functions for dates, encoding, and other utilities.
                        </div>
                        <div class="code-block">
# Date and time functions
locals {
  # Current timestamp
  current_time = timestamp()  # "2024-01-19T10:30:00Z"
  
  # Format timestamp
  date_tag = formatdate("YYYY-MM-DD", timestamp())  # "2024-01-19"
  
  # Time-based naming
  backup_name = "${var.environment}-backup-${formatdate("YYYYMMDD-hhmm", timestamp())}"
}

# Encoding functions
locals {
  # Base64 encoding
  startup_script_b64 = base64encode(file("startup.sh"))
  
  # JSON encoding
  metadata_json = jsonencode({
    environment = var.environment
    created_by  = "terraform"
    timestamp   = timestamp()
  })
  
  # URL encoding
  safe_url = urlencode("hello world")  # "hello%20world"
}

# File functions
locals {
  # Read file content
  startup_script = file("${path.module}/scripts/startup.sh")
  
  # Template file with variables
  user_data = templatefile("${path.module}/templates/user-data.tpl", {
    environment = var.environment
    project_id  = var.project_id
  })
  
  # File paths
  module_path = path.module      # Current module directory
  root_path   = path.root        # Root module directory
  current_dir = path.cwd         # Current working directory
}

# Real example from our project:
resource "google_compute_instance" "vm" {
  metadata = {
    user-data = templatefile("${path.module}/templates/cloud-init.yaml", {
      environment    = var.environment
      project_id     = var.project_id
      service_account = var.service_account_email
    })
    
    created-by = "terraform"
    created-at = timestamp()
  }
  
  metadata_startup_script = file("${path.module}/scripts/startup.sh")
}
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Function Playground</h3>
                    <p>Try different Terraform functions with our project data:</p>
                    <button class="demo-button" onclick="showFunctionPlayground()">Open Function Playground</button>
                    <div id="function-playground" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Function Examples with Our Project:</h4>
                            <div style="text-align: left; margin-top: 15px; font-family: monospace;">
                                <p><strong>String Functions:</strong></p>
                                <code>
environment = "dev"<br>
upper(var.environment) = "DEV"<br>
"${var.environment}-vm" = "dev-vm"<br>
replace("praxis-gear-483220-k4", "-", "_") = "praxis_gear_483220_k4"
                                </code>
                                
                                <p style="margin-top: 15px;"><strong>List Functions:</strong></p>
                                <code>
zones = ["us-central1-a", "us-central1-b", "us-central1-c"]<br>
length(var.zones) = 3<br>
var.zones[0] = "us-central1-a"<br>
join(",", var.zones) = "us-central1-a,us-central1-b,us-central1-c"
                                </code>
                                
                                <p style="margin-top: 15px;"><strong>Conditional Functions:</strong></p>
                                <code>
var.environment == "prod" ? "e2-standard-4" : "e2-medium" = "e2-medium"<br>
coalesce(null, "default-value") = "default-value"<br>
can(tonumber("123")) = true<br>
try(tonumber("abc"), 0) = 0
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Meta Arguments Tab -->
            <div id="meta-tab" class="tab-content">
                <h2 class="section-title">ğŸ¯ Meta Arguments</h2>
                <p class="section-subtitle">Master count, for_each, depends_on, lifecycle, and provider meta-arguments</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”¢</span>
                        <h3 class="concept-title">count - Create Multiple Resources</h3>
                        <div class="concept-description">
                            Create multiple similar resources using a numeric index.
                        </div>
                        <div class="code-block">
# Basic count usage
resource "google_compute_instance" "web" {
  count = 3  # Creates 3 VMs
  
  name         = "web-${count.index}"  # web-0, web-1, web-2
  machine_type = "e2-medium"
  zone         = var.zones[count.index]
}

# Conditional resource creation
resource "google_compute_instance" "bastion" {
  count = var.create_bastion ? 1 : 0  # Create only if needed
  
  name         = "bastion-host"
  machine_type = "e2-micro"
}

# Count with list length
variable "vm_names" {
  default = ["web", "api", "db"]
}

resource "google_compute_instance" "servers" {
  count = length(var.vm_names)
  
  name         = "${var.vm_names[count.index]}-server"
  machine_type = "e2-medium"
}

# Accessing count resources
output "web_ips" {
  value = google_compute_instance.web[*].network_interface[0].access_config[0].nat_ip
}

# Real example from our project:
resource "google_compute_firewall" "allow_ports" {
  count = length(var.allowed_ports)
  
  name    = "${var.environment}-allow-${var.allowed_ports[count.index]}"
  network = var.network_name
  
  allow {
    protocol = "tcp"
    ports    = [var.allowed_ports[count.index]]
  }
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”„</span>
                        <h3 class="concept-title">for_each - Create Resources from Map/Set</h3>
                        <div class="concept-description">
                            Create resources based on a map or set, with more flexibility than count.
                        </div>
                        <div class="code-block">
# for_each with map
variable "environments" {
  default = {
    dev = {
      machine_type = "e2-medium"
      disk_size    = 20
    }
    staging = {
      machine_type = "e2-standard-2"
      disk_size    = 50
    }
    prod = {
      machine_type = "e2-standard-4"
      disk_size    = 100
    }
  }
}

resource "google_compute_instance" "env_vms" {
  for_each = var.environments
  
  name         = "${each.key}-vm"           # dev-vm, staging-vm, prod-vm
  machine_type = each.value.machine_type   # Access map values
  zone         = "us-central1-a"
  
  boot_disk {
    initialize_params {
      size = each.value.disk_size
    }
  }
}

# for_each with set
variable "firewall_rules" {
  default = ["ssh", "http", "https"]
}

resource "google_compute_firewall" "rules" {
  for_each = toset(var.firewall_rules)  # Convert list to set
  
  name    = "${var.environment}-allow-${each.key}"
  network = var.network_name
  
  allow {
    protocol = "tcp"
    ports = each.key == "ssh" ? ["22"] : 
            each.key == "http" ? ["80"] : ["443"]
  }
}

# Accessing for_each resources
output "vm_ips" {
  value = {
    for k, v in google_compute_instance.env_vms : k => v.network_interface[0].network_ip
  }
}

# Real example from our security module:
resource "google_compute_firewall" "allow_rules" {
  for_each = {
    ssh   = { port = "22", source_ranges = var.ssh_source_ranges }
    http  = { port = "80", source_ranges = ["0.0.0.0/0"] }
    https = { port = "443", source_ranges = ["0.0.0.0/0"] }
    icmp  = { protocol = "icmp", source_ranges = [var.subnet_cidr] }
  }
  
  name    = "${var.environment}-allow-${each.key}"
  network = var.network_name
  
  allow {
    protocol = lookup(each.value, "protocol", "tcp")
    ports    = lookup(each.value, "port", null) != null ? [each.value.port] : null
  }
  
  source_ranges = each.value.source_ranges
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”—</span>
                        <h3 class="concept-title">depends_on - Explicit Dependencies</h3>
                        <div class="concept-description">
                            Explicitly define dependencies when Terraform can't infer them automatically.
                        </div>
                        <div class="code-block">
# Implicit dependency (Terraform detects automatically)
resource "google_compute_network" "vpc" {
  name = "my-vpc"
}

resource "google_compute_subnetwork" "subnet" {
  name    = "my-subnet"
  network = google_compute_network.vpc.id  # Implicit dependency
}

# Explicit dependency (when Terraform can't detect)
resource "google_compute_instance" "vm" {
  name         = "my-vm"
  machine_type = "e2-medium"
  
  # Explicit dependency - VM needs firewall rules to exist first
  depends_on = [
    google_compute_firewall.allow_ssh,
    google_compute_firewall.allow_http
  ]
}

resource "google_compute_firewall" "allow_ssh" {
  name    = "allow-ssh"
  network = google_compute_network.vpc.name
  
  allow {
    protocol = "tcp"
    ports    = ["22"]
  }
}

# Module dependencies
module "network" {
  source = "./modules/network"
}

module "compute" {
  source = "./modules/compute"
  
  # Explicit dependency on entire module
  depends_on = [module.network]
  
  network_name = module.network.vpc_name
}

# Real example from our project:
resource "google_compute_instance" "vm" {
  name         = "${var.environment}-vm"
  machine_type = var.machine_type
  
  # Ensure IAM bindings are created before VM
  depends_on = [
    google_project_iam_member.vm_sa_compute_viewer,
    google_project_iam_member.vm_sa_storage_viewer
  ]
  
  service_account {
    email  = google_service_account.vm_service_account.email
    scopes = ["cloud-platform"]
  }
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">â™»ï¸</span>
                        <h3 class="concept-title">lifecycle - Resource Lifecycle Management</h3>
                        <div class="concept-description">
                            Control how Terraform creates, updates, and destroys resources.
                        </div>
                        <div class="code-block">
# Prevent resource destruction
resource "google_compute_instance" "critical_vm" {
  name         = "production-database"
  machine_type = "e2-standard-4"
  
  lifecycle {
    prevent_destroy = true  # Terraform will refuse to destroy this
  }
}

# Create before destroy (for zero-downtime updates)
resource "google_compute_instance_template" "web" {
  name         = "web-template-${random_id.template.hex}"
  machine_type = "e2-medium"
  
  lifecycle {
    create_before_destroy = true  # Create new before destroying old
  }
}

# Ignore changes to specific attributes
resource "google_compute_instance" "vm" {
  name         = "my-vm"
  machine_type = "e2-medium"
  
  metadata = {
    startup-script = file("startup.sh")
  }
  
  lifecycle {
    ignore_changes = [
      metadata["startup-script"],  # Ignore changes to startup script
      labels,                      # Ignore label changes
    ]
  }
}

# Replace triggered by changes
resource "google_compute_instance" "vm" {
  name         = "my-vm"
  machine_type = var.machine_type
  
  lifecycle {
    replace_triggered_by = [
      var.force_replacement_trigger  # Replace when this variable changes
    ]
  }
}

# Real example from our project:
resource "google_compute_instance" "vm" {
  name         = "${var.environment}-vm"
  machine_type = var.machine_type
  
  boot_disk {
    initialize_params {
      image = var.vm_image
      size  = var.disk_size
    }
  }
  
  lifecycle {
    # Don't recreate VM if image changes (security updates)
    ignore_changes = [
      boot_disk[0].initialize_params[0].image
    ]
    
    # Prevent accidental deletion in production
    prevent_destroy = var.environment == "prod" ? true : false
  }
}
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Meta Arguments Comparison</h3>
                    <p>Compare count vs for_each with practical examples:</p>
                    <button class="demo-button" onclick="showMetaComparison()">Compare Meta Arguments</button>
                    <div id="meta-comparison" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>count vs for_each Comparison:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <p><strong>Use count when:</strong></p>
                                <ul>
                                    <li>âœ… Creating identical resources</li>
                                    <li>âœ… Number of resources is known</li>
                                    <li>âœ… Resources don't need unique configuration</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Use for_each when:</strong></p>
                                <ul>
                                    <li>âœ… Each resource needs different configuration</li>
                                    <li>âœ… Resources have meaningful names/keys</li>
                                    <li>âœ… You might add/remove specific resources</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>Example - Creating firewall rules:</strong></p>
                                <code>
# âŒ count - Hard to manage<br>
count = 3<br>
ports = ["22", "80", "443"][count.index]<br><br>

# âœ… for_each - Clear and flexible<br>
for_each = { ssh = "22", http = "80", https = "443" }<br>
ports = [each.value]
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- WIF Deep Dive Tab -->
            <div id="wif-tab" class="tab-content">
                <h2 class="section-title">ğŸ” Workload Identity Federation Deep Dive</h2>
                <p class="section-subtitle">Understanding how WIF enables secure, keyless authentication from GitHub Actions</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”‘</span>
                        <h3 class="concept-title">What is Workload Identity Federation?</h3>
                        <div class="concept-description">
                            WIF allows external workloads (like GitHub Actions) to authenticate to GCP without service account keys.
                        </div>
                        <div class="code-block">
# Traditional approach (âŒ NOT SECURE)
# 1. Create service account key
# 2. Download JSON key file
# 3. Store key in GitHub Secrets
# 4. Use key in GitHub Actions

# Problems with keys:
# âŒ Keys can be stolen or leaked
# âŒ Keys don't expire automatically
# âŒ Hard to rotate keys
# âŒ No fine-grained access control

# WIF approach (âœ… SECURE)
# 1. Create Workload Identity Pool
# 2. Create Provider (GitHub OIDC)
# 3. Bind service account to pool
# 4. GitHub Actions gets temporary token
# 5. Token exchanged for GCP access token

# Benefits of WIF:
# âœ… No long-lived keys
# âœ… Automatic token expiration
# âœ… Fine-grained access control
# âœ… Audit trail of all access
# âœ… Can restrict by repository, branch, etc.
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ—ï¸</span>
                        <h3 class="concept-title">WIF Architecture in Our Project</h3>
                        <div class="concept-description">
                            How our shared WIF setup enables secure CI/CD across all environments.
                        </div>
                        <div class="code-block">
# Our WIF Architecture:

ğŸ“¦ shared/wif/
â”œâ”€â”€ main.tf          # WIF pool and provider
â”œâ”€â”€ variables.tf     # Configuration variables
â””â”€â”€ outputs.tf       # Pool name and SA email

# 1. Workload Identity Pool (shared/wif/main.tf)
resource "google_iam_workload_identity_pool" "github_pool" {
  workload_identity_pool_id = "github-actions-pool"
  display_name              = "GitHub Actions Pool"
  description               = "Shared GitHub Actions authentication pool"
}

# 2. GitHub OIDC Provider
resource "google_iam_workload_identity_pool_provider" "github_provider" {
  workload_identity_pool_id          = google_iam_workload_identity_pool.github_pool.workload_identity_pool_id
  workload_identity_pool_provider_id = "github-actions"
  
  # Map GitHub token claims to GCP attributes
  attribute_mapping = {
    "google.subject"       = "assertion.sub"
    "attribute.actor"      = "assertion.actor"
    "attribute.repository" = "assertion.repository"
    "attribute.aud"        = "assertion.aud"
  }
  
  # Only allow our specific repository
  attribute_condition = "assertion.repository == 'your-org/your-repo'"
  
  oidc {
    issuer_uri = "https://token.actions.githubusercontent.com"
  }
}

# 3. Service Account for GitHub Actions
resource "google_service_account" "github_actions_sa" {
  account_id   = "github-actions-sa"
  display_name = "GitHub Actions Service Account"
}

# 4. Bind Service Account to WIF Pool
resource "google_service_account_iam_binding" "github_actions_wif_binding" {
  service_account_id = google_service_account.github_actions_sa.name
  role               = "roles/iam.workloadIdentityUser"
  
  members = [
    "principalSet://iam.googleapis.com/${google_iam_workload_identity_pool.github_pool.name}/attribute.repository/your-org/your-repo"
  ]
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”„</span>
                        <h3 class="concept-title">WIF Authentication Flow</h3>
                        <div class="concept-description">
                            Step-by-step process of how GitHub Actions authenticates to GCP using WIF.
                        </div>
                        <div class="flow-diagram">
                            <div class="flow-step">GitHub Action Starts</div>
                            <div class="flow-step">Request OIDC Token</div>
                            <div class="flow-step">GitHub Issues JWT</div>
                            <div class="flow-step">Exchange for GCP Token</div>
                            <div class="flow-step">Access GCP Resources</div>
                        </div>
                        <div class="code-block">
# Detailed Authentication Flow:

1. ğŸš€ GitHub Action starts running
   - Workflow triggered by push/PR
   - GitHub generates OIDC token for the job

2. ğŸ« GitHub OIDC Token contains claims:
   {
     "iss": "https://token.actions.githubusercontent.com",
     "sub": "repo:your-org/your-repo:ref:refs/heads/main",
     "aud": "sts.googleapis.com",
     "repository": "your-org/your-repo",
     "actor": "username",
     "workflow": "CI/CD Pipeline"
   }

3. ğŸ”„ Token Exchange Process:
   - GitHub Action calls Google STS API
   - Provides OIDC token + WIF pool info
   - Google validates token signature
   - Google checks attribute conditions

4. âœ… Google Issues Access Token:
   - Short-lived (1 hour) access token
   - Scoped to service account permissions
   - Can be used for GCP API calls

5. ğŸ¯ GitHub Action uses token:
   - Authenticate to GCP
   - Run terraform commands
   - Deploy infrastructure

# In GitHub Actions workflow:
- name: Authenticate to Google Cloud
  uses: google-github-actions/auth@v1
  with:
    workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions'
    service_account: 'github-actions-sa@my-project.iam.gserviceaccount.com'

- name: Deploy with Terraform
  run: |
    terraform init
    terraform plan
    terraform apply -auto-approve
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ›¡ï¸</span>
                        <h3 class="concept-title">WIF Security Best Practices</h3>
                        <div class="concept-description">
                            Security considerations and best practices for WIF implementation.
                        </div>
                        <div class="code-block">
# Security Best Practices:

# 1. Restrict by Repository
attribute_condition = "assertion.repository == 'your-org/your-repo'"

# 2. Restrict by Branch (optional)
attribute_condition = "assertion.repository == 'your-org/your-repo' && assertion.ref == 'refs/heads/main'"

# 3. Restrict by Environment (optional)
attribute_condition = "assertion.repository == 'your-org/your-repo' && assertion.environment == 'production'"

# 4. Principle of Least Privilege
resource "google_project_iam_member" "github_actions_permissions" {
  for_each = toset([
    "roles/compute.admin",              # Only what's needed
    "roles/iam.serviceAccountAdmin",    # For service account management
    "roles/storage.admin"               # For state bucket access
  ])
  
  project = var.project_id
  role    = each.value
  member  = "serviceAccount:${google_service_account.github_actions_sa.email}"
}

# 5. Separate Service Accounts per Environment
resource "google_service_account" "github_actions_dev" {
  account_id = "github-actions-dev"
  # Limited permissions for dev
}

resource "google_service_account" "github_actions_prod" {
  account_id = "github-actions-prod"
  # Full permissions for prod, restricted conditions
}

# 6. Audit and Monitoring
# Enable Cloud Audit Logs
# Monitor service account usage
# Set up alerts for unusual activity

# 7. Token Expiration
# OIDC tokens expire in 15 minutes
# Access tokens expire in 1 hour
# No long-lived credentials

# 8. Conditional Access Examples:
# Only from main branch:
"assertion.ref == 'refs/heads/main'"

# Only from specific actor:
"assertion.actor == 'trusted-user'"

# Only from pull requests:
"assertion.event_name == 'pull_request'"

# Combined conditions:
"assertion.repository == 'your-org/your-repo' && assertion.ref == 'refs/heads/main' && assertion.actor in ['user1', 'user2']"
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: WIF vs Service Account Keys</h3>
                    <p>Compare traditional service account keys with WIF:</p>
                    <button class="demo-button" onclick="showWIFComparison()">Compare Authentication Methods</button>
                    <div id="wif-comparison" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Authentication Methods Comparison:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <p><strong>âŒ Service Account Keys (Old Way):</strong></p>
                                        <ul style="font-size: 0.9rem;">
                                            <li>Long-lived credentials (no expiration)</li>
                                            <li>JSON key files can be stolen</li>
                                            <li>Hard to rotate keys</li>
                                            <li>No audit trail of key usage</li>
                                            <li>Keys stored in GitHub Secrets</li>
                                            <li>Risk of accidental exposure</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <p><strong>âœ… Workload Identity Federation (New Way):</strong></p>
                                        <ul style="font-size: 0.9rem;">
                                            <li>Short-lived tokens (1 hour max)</li>
                                            <li>No secrets to steal or leak</li>
                                            <li>Automatic token rotation</li>
                                            <li>Complete audit trail</li>
                                            <li>No secrets in GitHub</li>
                                            <li>Fine-grained access control</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <p style="margin-top: 20px;"><strong>Migration Benefits:</strong></p>
                                <ul>
                                    <li>ğŸ”’ Enhanced security posture</li>
                                    <li>ğŸ“Š Better compliance and auditing</li>
                                    <li>ğŸš€ Simplified key management</li>
                                    <li>ğŸ¯ Granular access controls</li>
                                    <li>âš¡ Faster incident response</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Tab -->
            <div id="advanced-tab" class="tab-content">
                <h2 class="section-title">ğŸš€ Advanced Terraform Concepts</h2>
                <p class="section-subtitle">Master advanced patterns, troubleshooting, and enterprise practices</p>
                
                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”§</span>
                        <h3 class="concept-title">Dynamic Blocks</h3>
                        <div class="concept-description">
                            Generate repeating nested blocks dynamically based on variables or data.
                        </div>
                        <div class="code-block">
# Static blocks (repetitive)
resource "google_compute_firewall" "web" {
  name = "web-firewall"
  
  allow {
    protocol = "tcp"
    ports    = ["80"]
  }
  
  allow {
    protocol = "tcp"
    ports    = ["443"]
  }
  
  allow {
    protocol = "tcp"
    ports    = ["22"]
  }
}

# Dynamic blocks (flexible)
variable "firewall_rules" {
  default = [
    { protocol = "tcp", ports = ["80"] },
    { protocol = "tcp", ports = ["443"] },
    { protocol = "tcp", ports = ["22"] },
    { protocol = "icmp", ports = [] }
  ]
}

resource "google_compute_firewall" "web" {
  name = "web-firewall"
  
  dynamic "allow" {
    for_each = var.firewall_rules
    content {
      protocol = allow.value.protocol
      ports    = allow.value.ports
    }
  }
}

# Complex dynamic blocks
variable "network_interfaces" {
  default = [
    {
      network    = "default"
      subnetwork = "default-subnet"
      external_ip = true
    },
    {
      network    = "internal"
      subnetwork = "internal-subnet"
      external_ip = false
    }
  ]
}

resource "google_compute_instance" "vm" {
  name = "multi-nic-vm"
  
  dynamic "network_interface" {
    for_each = var.network_interfaces
    content {
      network    = network_interface.value.network
      subnetwork = network_interface.value.subnetwork
      
      dynamic "access_config" {
        for_each = network_interface.value.external_ip ? [1] : []
        content {
          # Ephemeral external IP
        }
      }
    }
  }
}

# Real example from our project:
resource "google_compute_instance" "vm" {
  name = "${var.environment}-vm"
  
  dynamic "network_interface" {
    for_each = var.network_interfaces
    content {
      network    = network_interface.value.network
      subnetwork = network_interface.value.subnetwork
      network_ip = lookup(network_interface.value, "internal_ip", null)
      
      dynamic "access_config" {
        for_each = lookup(network_interface.value, "external_ip", false) ? [1] : []
        content {
          nat_ip = lookup(network_interface.value, "static_ip", null)
        }
      }
    }
  }
}
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ­</span>
                        <h3 class="concept-title">Workspaces & Environment Management</h3>
                        <div class="concept-description">
                            Manage multiple environments using Terraform workspaces and directory structures.
                        </div>
                        <div class="code-block">
# Workspace Commands
terraform workspace list        # List all workspaces
terraform workspace new dev     # Create new workspace
terraform workspace select dev  # Switch to workspace
terraform workspace show       # Show current workspace
terraform workspace delete dev # Delete workspace

# Workspace-aware configuration
resource "google_compute_instance" "vm" {
  name = "${terraform.workspace}-vm"  # dev-vm, staging-vm, prod-vm
  
  machine_type = terraform.workspace == "prod" ? "e2-standard-4" : "e2-medium"
  
  labels = {
    environment = terraform.workspace
    workspace   = terraform.workspace
  }
}

# Workspace-specific variables
locals {
  workspace_config = {
    dev = {
      machine_type = "e2-medium"
      disk_size    = 20
      zone_count   = 1
    }
    staging = {
      machine_type = "e2-standard-2"
      disk_size    = 50
      zone_count   = 2
    }
    prod = {
      machine_type = "e2-standard-4"
      disk_size    = 100
      zone_count   = 3
    }
  }
  
  current_config = local.workspace_config[terraform.workspace]
}

# Our approach: Directory-based environments
# âœ… Pros:
# - Clear separation of environments
# - Different backend configurations
# - Environment-specific variables
# - Easy to understand and maintain

# âŒ Workspace approach drawbacks:
# - Shared backend (risk of conflicts)
# - Easy to accidentally deploy to wrong environment
# - Harder to have different provider configurations

# Directory structure (our approach):
environments/
â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ main.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â””â”€â”€ backend.tf
â”œâ”€â”€ staging/
â”‚   â”œâ”€â”€ main.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ terraform.tfvars
â”‚   â””â”€â”€ backend.tf
â””â”€â”€ prod/
    â”œâ”€â”€ main.tf
    â”œâ”€â”€ variables.tf
    â”œâ”€â”€ terraform.tfvars
    â””â”€â”€ backend.tf

# Each environment has its own:
# - State file location
# - Variable values
# - Provider configurations
# - Resource naming
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ”</span>
                        <h3 class="concept-title">Troubleshooting & Debugging</h3>
                        <div class="concept-description">
                            Common issues, debugging techniques, and troubleshooting strategies.
                        </div>
                        <div class="code-block">
# Enable detailed logging
export TF_LOG=DEBUG
export TF_LOG_PATH=terraform.log
terraform apply

# Common debugging commands
terraform validate          # Check syntax and configuration
terraform fmt -check       # Check formatting
terraform plan -detailed-exitcode  # Exit codes: 0=no changes, 1=error, 2=changes

# State debugging
terraform state list                    # List all resources
terraform state show resource.name     # Show resource details
terraform refresh                      # Sync state with reality
terraform import resource.name id      # Import existing resource

# Common Issues and Solutions:

# 1. Resource already exists
Error: A resource with the ID "my-vm" already exists

Solution:
terraform import google_compute_instance.vm projects/my-project/zones/us-central1-a/instances/my-vm

# 2. State lock issues
Error: Error locking state: Error acquiring the state lock

Solution:
terraform force-unlock LOCK_ID

# 3. Provider version conflicts
Error: Unsupported Terraform Core version

Solution:
terraform {
  required_version = ">= 1.0"
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.45.0"
    }
  }
}

# 4. Circular dependencies
Error: Cycle: resource.a, resource.b

Solution:
# Remove implicit dependencies, use explicit depends_on
resource "example" "a" {
  depends_on = [example.b]
}

# 5. Permission errors
Error: googleapi: Error 403: Insufficient Permission

Solution:
# Check service account permissions
# Verify WIF configuration
# Enable required APIs

# Debugging techniques:
# 1. Use terraform plan to preview changes
# 2. Apply changes incrementally
# 3. Use terraform state commands to inspect state
# 4. Check provider documentation
# 5. Use terraform console for testing expressions
# 6. Enable debug logging for detailed output

# Testing expressions in terraform console:
$ terraform console
> var.environment
"dev"
> "${var.environment}-vm"
"dev-vm"
> length(var.zones)
3
                        </div>
                    </div>
                    
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ¢</span>
                        <h3 class="concept-title">Enterprise Patterns & Best Practices</h3>
                        <div class="concept-description">
                            Production-ready patterns for large-scale Terraform deployments.
                        </div>
                        <div class="code-block">
# 1. Module Versioning
module "network" {
  source  = "git::https://github.com/company/terraform-modules.git//network?ref=v1.2.0"
  version = "~> 1.2"  # For registry modules
}

# 2. Remote State Data Sources
data "terraform_remote_state" "shared_services" {
  backend = "gcs"
  config = {
    bucket = "company-terraform-state"
    prefix = "shared/services"
  }
}

# 3. Naming Conventions
locals {
  # Consistent naming across all resources
  name_prefix = "${var.organization}-${var.environment}-${var.application}"
  
  common_tags = {
    Organization = var.organization
    Environment  = var.environment
    Application  = var.application
    ManagedBy    = "terraform"
    CostCenter   = var.cost_center
    Owner        = var.team_email
  }
}

# 4. Policy as Code
# Use Open Policy Agent (OPA) with Terraform
# Sentinel policies (Terraform Cloud/Enterprise)
# Custom validation rules

# 5. CI/CD Pipeline Structure
# .github/workflows/terraform.yml
name: Terraform CI/CD
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      - name: Terraform Plan
        run: |
          terraform init
          terraform plan -out=tfplan
      - name: Save Plan
        uses: actions/upload-artifact@v3
        with:
          name: tfplan
          path: tfplan

  apply:
    needs: plan
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download Plan
        uses: actions/download-artifact@v3
      - name: Terraform Apply
        run: terraform apply tfplan

# 6. State Management Best Practices
# - Separate state files per environment
# - Use remote backends with locking
# - Regular state backups
# - State file encryption
# - Access control on state buckets

# 7. Security Best Practices
# - Use WIF instead of service account keys
# - Principle of least privilege
# - Separate service accounts per environment
# - Enable audit logging
# - Scan for security vulnerabilities
# - Use private registries for modules

# 8. Monitoring and Alerting
# - Monitor Terraform runs
# - Alert on failed deployments
# - Track resource drift
# - Cost monitoring and alerts
# - Compliance monitoring

# 9. Documentation Standards
# - README.md for each module
# - Variable descriptions
# - Output descriptions
# - Architecture diagrams
# - Runbooks for operations
                        </div>
                    </div>
                </div>
                
                <div class="interactive-demo">
                    <h3>ğŸ® Interactive Demo: Complete Project Walkthrough</h3>
                    <p>Take a guided tour through our entire Terraform project:</p>
                    <button class="demo-button" onclick="showProjectWalkthrough()">Start Project Tour</button>
                    <div id="project-walkthrough" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                            <h4>Complete Project Architecture:</h4>
                            <div style="text-align: left; margin-top: 15px;">
                                <p><strong>ğŸ—ï¸ Infrastructure Components:</strong></p>
                                <ul>
                                    <li><strong>Shared WIF:</strong> Centralized authentication for all environments</li>
                                    <li><strong>Network Module:</strong> VPC, subnets, NAT gateway, Cloud Router</li>
                                    <li><strong>Security Module:</strong> Firewall rules, IAM policies</li>
                                    <li><strong>Compute Module:</strong> VM instances with proper service accounts</li>
                                    <li><strong>IAM Module:</strong> Service accounts and role bindings</li>
                                </ul>
                                
                                <p style="margin-top: 15px;"><strong>ğŸ”„ Deployment Flow:</strong></p>
                                <ol>
                                    <li>Deploy shared WIF infrastructure (one-time)</li>
                                    <li>Deploy environment-specific infrastructure</li>
                                    <li>GitHub Actions uses WIF for authentication</li>
                                    <li>Terraform manages state in GCS buckets</li>
                                    <li>Resources created with consistent naming and tagging</li>
                                </ol>
                                
                                <p style="margin-top: 15px;"><strong>ğŸ¯ Key Learning Points:</strong></p>
                                <ul>
                                    <li>Modular architecture for reusability</li>
                                    <li>Secure authentication without keys</li>
                                    <li>Environment separation with shared components</li>
                                    <li>Proper state management and locking</li>
                                    <li>Enterprise-ready patterns and practices</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }
        
        function showTerraformProcess() {
            const element = document.getElementById('terraform-process');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showModuleFlow() {
            const element = document.getElementById('module-communication');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showVariableFlow() {
            const element = document.getElementById('variable-flow-demo');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showModuleExecution() {
            const element = document.getElementById('module-execution-demo');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showStateAnalysis() {
            const element = document.getElementById('state-analysis-demo');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showWorkflowSimulation() {
            const element = document.getElementById('workflow-simulation');
            const stepsElement = document.getElementById('workflow-steps');
            
            if (element.style.display === 'none' || element.style.display === '') {
                element.style.display = 'block';
                simulateWorkflow();
            } else {
                element.style.display = 'none';
            }
        }
        
        function simulateWorkflow() {
            const steps = [
                '$ terraform init',
                'Initializing the backend...',
                'Initializing provider plugins...',
                'Terraform has been successfully initialized!',
                '',
                '$ terraform plan',
                'Refreshing state...',
                'Plan: 15 to add, 0 to change, 0 to destroy.',
                '',
                '$ terraform apply',
                'Do you want to perform these actions? yes',
                'Creating resources...',
                'Apply complete! Resources: 15 added, 0 changed, 0 destroyed.',
                '',
                '$ terraform destroy',
                'Plan: 0 to add, 0 to change, 15 to destroy.',
                'Do you really want to destroy all resources? yes',
                'Destroying resources...',
                'Destroy complete! Resources: 15 destroyed.'
            ];
            
            const stepsElement = document.getElementById('workflow-steps');
            stepsElement.innerHTML = '';
            
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.textContent = step;
                    div.style.marginBottom = '5px';
                    if (step.startsWith('$')) {
                        div.style.color = '#10b981';
                        div.style.fontWeight = 'bold';
                    }
                    stepsElement.appendChild(div);
                }, index * 200);
            });
        }
        
        function showFunctionPlayground() {
            const element = document.getElementById('function-playground');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showMetaComparison() {
            const element = document.getElementById('meta-comparison');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showWIFComparison() {
            const element = document.getElementById('wif-comparison');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function showProjectWalkthrough() {
            const element = document.getElementById('project-walkthrough');
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Create module flow diagram
            createModuleFlowDiagram();
        });
        
        function createModuleFlowDiagram() {
            const container = document.getElementById('module-flow');
            if (!container) return;
            
            // Simple SVG diagram showing module relationships
            container.innerHTML = `
                <svg width="100%" height="400" viewBox="0 0 800 400">
                    <!-- Root Module -->
                    <rect x="300" y="20" width="200" height="60" rx="10" fill="#623CE4" />
                    <text x="400" y="45" text-anchor="middle" fill="white" font-weight="bold">Root Module</text>
                    <text x="400" y="65" text-anchor="middle" fill="white" font-size="12">environments/dev/</text>
                    
                    <!-- Child Modules -->
                    <rect x="50" y="150" width="120" height="50" rx="8" fill="#4285F4" />
                    <text x="110" y="170" text-anchor="middle" fill="white" font-weight="bold">Network</text>
                    <text x="110" y="185" text-anchor="middle" fill="white" font-size="10">modules/network</text>
                    
                    <rect x="200" y="150" width="120" height="50" rx="8" fill="#4285F4" />
                    <text x="260" y="170" text-anchor="middle" fill="white" font-weight="bold">IAM</text>
                    <text x="260" y="185" text-anchor="middle" fill="white" font-size="10">modules/iam</text>
                    
                    <rect x="350" y="150" width="120" height="50" rx="8" fill="#4285F4" />
                    <text x="410" y="170" text-anchor="middle" fill="white" font-weight="bold">Security</text>
                    <text x="410" y="185" text-anchor="middle" fill="white" font-size="10">modules/security</text>
                    
                    <rect x="500" y="150" width="120" height="50" rx="8" fill="#4285F4" />
                    <text x="560" y="170" text-anchor="middle" fill="white" font-weight="bold">Compute</text>
                    <text x="560" y="185" text-anchor="middle" fill="white" font-size="10">modules/compute</text>
                    
                    <!-- Arrows from Root to Child Modules -->
                    <line x1="350" y1="80" x2="110" y2="150" stroke="#623CE4" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="380" y1="80" x2="260" y2="150" stroke="#623CE4" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="420" y1="80" x2="410" y2="150" stroke="#623CE4" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="450" y1="80" x2="560" y2="150" stroke="#623CE4" stroke-width="2" marker-end="url(#arrowhead)" />
                    
                    <!-- Data Flow Arrows -->
                    <line x1="170" y1="175" x2="350" y2="175" stroke="#10b981" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead-green)" />
                    <line x1="320" y1="175" x2="500" y2="175" stroke="#10b981" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead-green)" />
                    
                    <!-- GCP Resources -->
                    <rect x="50" y="280" width="80" height="40" rx="5" fill="#f59e0b" />
                    <text x="90" y="295" text-anchor="middle" fill="white" font-size="10" font-weight="bold">VPC</text>
                    <text x="90" y="308" text-anchor="middle" fill="white" font-size="8">google_compute_network</text>
                    
                    <rect x="200" y="280" width="80" height="40" rx="5" fill="#f59e0b" />
                    <text x="240" y="295" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Service Account</text>
                    <text x="240" y="308" text-anchor="middle" fill="white" font-size="8">google_service_account</text>
                    
                    <rect x="350" y="280" width="80" height="40" rx="5" fill="#f59e0b" />
                    <text x="390" y="295" text-anchor="middle" fill="white" font-size="10" font-weight="bold">Firewall</text>
                    <text x="390" y="308" text-anchor="middle" fill="white" font-size="8">google_compute_firewall</text>
                    
                    <rect x="500" y="280" width="80" height="40" rx="5" fill="#f59e0b" />
                    <text x="540" y="295" text-anchor="middle" fill="white" font-size="10" font-weight="bold">VM Instance</text>
                    <text x="540" y="308" text-anchor="middle" fill="white" font-size="8">google_compute_instance</text>
                    
                    <!-- Arrows from Modules to Resources -->
                    <line x1="110" y1="200" x2="90" y2="280" stroke="#4285F4" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="260" y1="200" x2="240" y2="280" stroke="#4285F4" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="410" y1="200" x2="390" y2="280" stroke="#4285F4" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="560" y1="200" x2="540" y2="280" stroke="#4285F4" stroke-width="2" marker-end="url(#arrowhead)" />
                    
                    <!-- Legend -->
                    <text x="650" y="150" font-weight="bold" font-size="14">Legend:</text>
                    <line x1="650" y1="170" x2="680" y2="170" stroke="#623CE4" stroke-width="2" />
                    <text x="690" y="175" font-size="12">Module calls</text>
                    <line x1="650" y1="190" x2="680" y2="190" stroke="#10b981" stroke-width="2" stroke-dasharray="5,5" />
                    <text x="690" y="195" font-size="12">Data flow</text>
                    <line x1="650" y1="210" x2="680" y2="210" stroke="#4285F4" stroke-width="2" />
                    <text x="690" y="215" font-size="12">Creates resources</text>
                    
                    <!-- Arrow markers -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#623CE4" />
                        </marker>
                        <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                        </marker>
                    </defs>
                </svg>
            `;
        }
    </script>
</body>
</html>